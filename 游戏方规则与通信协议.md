# 谁是卧底 · 游戏方规则与通信协议

## 1. 文档目的
- 由主持人统一发送给全部参赛组，确保对游戏流程、交流约定和行为规范有一致理解。
- 涵盖基础规则、术语定义、通信协议以及异常处理办法。

## 2. 基础流程概览
1. 通过注册接口提交唯一的 `group_name`（推荐使用队名或谐音）。
2. 等待主持人宣布开局并接收身份及词语。
3. 主持人开启描述阶段后，按提示完成描述。
4. 主持人开启投票阶段后，提交本轮投票。
5. 主持人处理投票并公布淘汰结果、得分及下一轮安排。
6. 重复“描述-投票”直到判定胜负。

## 3. 角色与术语
- **游戏方**：参赛小组，使用本协议与主持端交互。
- **主持端**：Undercover 主持平台，负责身份分配、回合控制、积分统计。
- **平民词 / 卧底词**：主持人分配给不同身份的词语，两个词语语义相近。
- **描述阶段**：主持人开放时间段，允许每组提交一次描述。
- **投票阶段**：主持人开放时间段，允许每组提交一次投票对象。

## 4. 行为规范
- 禁止在描述中直接说出词语本体或透露身份。
- 描述、投票均仅能提交一次，提交后不可撤销。
- 如遇网络问题导致无法提交，请及时重连；断开连接会被视为退出游戏。

## 5. 通信约定

### 5.1 基础设置
- 协议：HTTP/HTTPS JSON API，字符集 UTF-8。
- **WebSocket 支持（可选但推荐）**：
  - 客户端可建立 WebSocket 连接以获得更准确的在线状态检测和实时数据推送。
  - 连接后需发送 `register_socket` 事件并携带 `group_name` 参数进行注册。
  - 建立连接后，客户端可以监听推送事件（如 `status_update`、`descriptions_update` 等）实时接收数据更新，减少 HTTP 轮询频率。
  - 详细的事件列表和数据格式请参考 5.5 节。
- 身份：`group_name` 在注册后即为唯一凭据；请勿与他人共享。
- 主持方控制接口（`/api/game/*`）受 `X-Admin-Token` 保护，仅主持端使用。
- 游戏方只需调用本节列出的开放接口。

### 5.2 开放 API 一览

| 场景 | 方法 | 路径 | 请求示例 | 响应示例 | 说明 |
|------|------|------|----------|----------|------|
| 注册组名 | `POST` | `/api/register` | `{ "group_name": "望月队" }` | `{ "code": 200, "message": "注册成功", "data": { "group_name": "望月队", "total_groups": 3 } }` | 每组仅注册一次 |
| 获取词语 | `GET` | `/api/word?group_name=望月队` | — | `{ "code": 200, "message": "ok", "data": { "word": "向日葵" } }` | 仅返回自己的词语 |
| 获取阶段状态 | `GET` | `/api/status?group_name=望月队` | — |详见5.3 | 轮询频率≤1次/3秒，建议传递 `group_name` 参数以更新活跃状态。**WebSocket 推送**：`status_update` 事件（详见5.5节） |
| 获取描述列表 | `GET` | `/api/descriptions?round=1` | — | `{ "code": 200, "message": "ok", "data": { "round": 1, "descriptions": [{ "group": "望月队", "description": "偏爱夜景的城市" }], "total": 3 } }` | 获取指定回合的描述列表，`round` 参数可选，默认当前回合。**WebSocket 推送**：`descriptions_update` 事件（详见5.5节） |
| 提交描述 | `POST` | `/api/describe` | `{ "group_name": "望月队", "description": "偏爱夜景的城市" }` | `{ "code": 200, "message": "描述提交成功", "data": { "round": 2, "total_descriptions": 3 } }` | 仅限描述阶段，需按发言顺序提交 |
| 提交投票 | `POST` | `/api/vote` | `{ "voter_group": "望月队", "target_group": "青木队" }` | `{ "code": 200, "message": "投票提交成功", "data": {} }` | 仅限投票阶段，禁止投自己 |
| 提交准备就绪 | `POST` | `/api/ready` | `{ "group_name": "望月队" }` | 详见5.3.1 | 在词语分配后或回合结束后调用，当所有人准备好时自动开始下一回合 |
| 获取最新结果 | `GET` | `/api/result` | — | 详见5.4 | 投票处理完成后可查，返回最近一轮投票的完整结果。**WebSocket 推送**：`vote_result` 事件（详见5.5节） |
| 获取所有组 | `GET` | `/api/groups` | — | `{ "code": 200, "message": "ok", "data": { "groups": [{ "name": "望月队", "registered_time": "2025-01-01T10:00:00", "eliminated": false }], "total": 3 } }` | 获取所有已注册的组信息。**WebSocket 推送**：`groups_update` 事件（详见5.5节） |
| 获取所有组总分 | `GET` | `/api/scores` | — | `{ "code": 200, "message": "ok", "data": { "scores": [{ "group_name": "望月队", "total_score": 5 }, { "group_name": "青木队", "total_score": 3 }], "total_groups": 2 } }` | 获取所有组的总分，按分数从高到低排序。**WebSocket 推送**：`scores_update` 事件（详见5.5节） |

> **提示**：所有响应体均采用 `{ "code": <状态码>, "message": "<文字信息>", "data": { ... } }` 结构；当 `code != 200` 时，需根据 `message` 判断失败原因。

### 5.3 `/api/status` 接口详细说明

`/api/status` 接口返回完整的游戏状态信息，响应 `data` 字段包含：

| 字段名 | 类型 | 说明 |
|--------|------|------|
| `status` | `string` | 游戏状态：`waiting`（等待注册）、`registered`（已注册）、`word_assigned`（词语已分配）、`describing`（描述阶段）、`voting`（投票阶段）、`round_end`（回合结束）、`game_end`（游戏结束） |
| `round` | `number` | 当前回合数 |
| `active_groups` | `array` | 当前活跃的组名列表（未淘汰的组） |
| `describe_order` | `array` | 描述阶段的发言顺序（仅在描述/投票阶段返回） |
| `current_speaker` | `string\|null` | 当前应该发言的组名（仅在描述阶段返回） |
| `current_speaker_index` | `number\|null` | 当前发言者在顺序中的索引（仅在描述阶段返回） |
| `eliminated_groups` | `array` | 已淘汰的组名列表 |
| `remaining_seconds` | `number\|null` | 当前阶段剩余时间（秒） |
| `speaker_remaining_seconds` | `number\|null` | 当前发言者剩余时间（秒，仅在描述阶段返回） |
| `descriptions` | `array` | 当前回合已提交的描述列表，格式：`[{ "group": "组名", "description": "描述内容" }]` |
| `voted_groups` | `array` | 当前回合已投票的组名列表 |
| `scores` | `object` | 所有组的累计总分，格式：`{ "组名": 分数 }`，例如：`{ "望月队": 5, "青木队": 3 }` |
| `ready_groups` | `array` | 已准备好开始回合的组名列表（仅在 `word_assigned` 或 `round_end` 状态时返回），例如：`["望月队", "青木队"]` |
| `online_status` | `object` | 各组的在线状态，格式：`{ "组名": true/false }`，例如：`{ "望月队": true, "青木队": false }` |

**响应示例**：
```json
{
  "code": 200,
  "message": "ok",
  "data": {
    "status": "describing",
    "round": 1,
    "active_groups": ["望月队", "青木队", "红叶队"],
    "describe_order": ["望月队", "青木队", "红叶队"],
    "current_speaker": "望月队",
    "current_speaker_index": 0,
    "eliminated_groups": [],
    "remaining_seconds": 150,
    "speaker_remaining_seconds": 25,
    "descriptions": [
      { "group": "望月队", "description": "偏爱夜景的城市" }
    ],
    "voted_groups": [],
    "scores": {
      "望月队": 5,
      "青木队": 3,
      "红叶队": 2
    }
  }
}
```

### 5.3.1 `/api/ready` 接口详细说明

`/api/ready` 接口用于提交准备就绪状态。当所有活跃玩家都准备好后，系统会自动开始下一回合。

**请求格式**：
- 方法：`POST`
- 路径：`/api/ready`
- 请求体：
```json
{
  "group_name": "望月队"
}
```

**响应格式**：
- 成功响应（`code: 200`）：
```json
{
  "code": 200,
  "message": "准备成功",
  "data": {
    "auto_started": false
  }
}
```

当所有人准备好时，响应会包含 `auto_started: true`，表示回合已自动开始：
```json
{
  "code": 200,
  "message": "所有人已准备好，回合已自动开始",
  "data": {
    "auto_started": true,
    "round": 1,
    "order": ["望月队", "青木队", "红叶队"]
  }
}
```

**使用场景**：
1. **词语分配后**：当游戏状态为 `word_assigned` 时，玩家可以调用此接口表示准备好开始第一回合。
2. **回合结束后**：当游戏状态为 `round_end` 时，玩家可以调用此接口表示准备好开始下一回合。

**注意事项**：
- 只有在 `word_assigned` 或 `round_end` 状态时才能调用此接口。
- 被淘汰的玩家不能调用此接口。
- 如果已经准备过，重复调用会返回"已经准备过了"的消息。
- 当所有活跃玩家都准备好时，系统会自动开始下一回合，无需主持人手动操作。
- 可以通过 `/api/status` 接口的 `ready_groups` 字段查看已准备的玩家列表。

### 5.4 `/api/result` 接口详细说明

`/api/result` 接口返回最近一轮投票的完整结果，响应 `data` 字段包含：

| 字段名 | 类型 | 说明 |
|--------|------|------|
| `round` | `number` | 回合数 |
| `vote_count` | `object` | 得票统计，格式：`{ "组名": 票数 }`，例如：`{ "青木队": 2, "红叶队": 1 }` |
| `vote_details` | `object` | 投票详情，格式：`{ "投票者": "被投票者" }`，例如：`{ "望月队": "青木队", "青木队": "红叶队" }` |
| `max_voted_groups` | `array` | 得票最多的组名列表 |
| `max_votes` | `number` | 最高票数 |
| `eliminated` | `array` | 被淘汰的组名列表 |
| `game_ended` | `boolean` | 游戏是否结束 |
| `winner` | `string\|null` | 获胜方：`"undercover"`（卧底胜利）或 `"civilian"`（平民胜利），游戏未结束时为 `null` |
| `message` | `string` | 结果消息文本 |
| `undercover_group` | `string\|null` | 卧底组名（游戏未开始时为 `null`） |
| `undercover_word` | `string` | 卧底词（仅游戏结束时返回） |
| `civilian_word` | `string` | 平民词（仅游戏结束时返回） |
| `round_scores` | `object` | 本轮得分，格式：`{ "组名": 得分 }` |
| `total_scores` | `object` | 累计总分，格式：`{ "组名": 总分 }` |
| `active_groups` | `array` | 当前活跃的组名列表（未淘汰的组） |
| `voted_groups` | `array` | 已投票的组名列表 |

**响应示例**：
```json
{
  "code": 200,
  "message": "ok",
  "data": {
    "round": 2,
    "vote_count": {
      "青木队": 2,
      "红叶队": 1
    },
    "vote_details": {
      "望月队": "青木队",
      "青木队": "红叶队",
      "红叶队": "青木队"
    },
    "max_voted_groups": ["青木队"],
    "max_votes": 2,
    "eliminated": ["青木队"],
    "game_ended": false,
    "winner": null,
    "message": "👋 投票结果：青木队 被投出，TA是平民。\n得票情况：青木队 获得 2 票\n游戏继续。",
    "undercover_group": "望月队",
    "undercover_word": "",
    "civilian_word": "",
    "round_scores": {
      "望月队": 1,
      "青木队": 0,
      "红叶队": 1
    },
    "total_scores": {
      "望月队": 5,
      "青木队": 3,
      "红叶队": 2
    },
    "active_groups": ["望月队", "红叶队"],
    "voted_groups": ["望月队", "青木队", "红叶队"]
  }
}
```

### 5.5 WebSocket 推送事件（可选）

客户端建立 WebSocket 连接后，可以通过监听以下事件实时接收数据更新，作为 HTTP 轮询的可选优化方案：

#### 5.5.1 事件列表

| 事件名 | 说明 | 对应 HTTP API | 触发时机 |
|--------|------|--------------|----------|
| `status_update` | 游戏状态更新 | `/api/status` | 游戏状态变化时 |
| `game_state_update` | 完整游戏状态更新 | `/api/game/state` | 游戏状态变化时（主持方用） |
| `vote_result` | 投票结果推送 | `/api/result` | 投票处理完成后 |
| `descriptions_update` | 描述列表更新 | `/api/descriptions` | 有新描述提交或新回合开始时 |
| `groups_update` | 组列表更新 | `/api/groups` | 有新组注册、游戏开始或玩家状态变化时 |
| `scores_update` | 分数更新 | `/api/scores` | 分数计算完成后或游戏重置时 |
| `timer_update` | 倒计时更新 | — | 描述/投票阶段每秒推送一次 |

#### 5.5.2 事件数据格式

**`descriptions_update` 事件**：
```json
{
  "round": 1,
  "descriptions": [
    {
      "group": "望月队",
      "description": "偏爱夜景的城市",
      "time": "2025-01-01T10:15:30.123456"
    }
  ],
  "total": 3
}
```

**说明**：
- `descriptions` 数组中的每个描述对象包含：
  - `group`（string）：组名
  - `description`（string）：描述内容
  - `time`（string）：描述提交时间，ISO 8601 格式（例如：`"2025-01-01T10:15:30.123456"`）

**`groups_update` 事件**：
```json
{
  "groups": [
    {
      "name": "望月队",
      "registered_time": "2025-01-01T10:00:00",
      "eliminated": false
    }
  ],
  "total": 3
}
```

**`scores_update` 事件**：
```json
{
  "scores": [
    {
      "group_name": "望月队",
      "total_score": 5
    },
    {
      "group_name": "青木队",
      "total_score": 3
    }
  ],
  "total_groups": 2
}
```

**`status_update` 事件**：
数据格式与 `/api/status` 接口的 `data` 字段相同，详见 5.3 节。

**`vote_result` 事件**：
数据格式与 `/api/result` 接口的 `data` 字段相同，详见 5.4 节。

#### 5.5.3 使用建议

- **推荐方案**：建立 WebSocket 连接并监听推送事件，同时保留 HTTP 轮询作为降级方案。
- **兼容性**：所有 HTTP API 接口仍然可用，客户端可以选择：
  - 仅使用 HTTP 轮询（传统方案）
  - 两者结合使用（WebSocket 用于实时更新，HTTP 用于初始加载和降级）

### 5.6 分数计算规则

每局游戏结束后，系统会根据以下规则计算并累加分数：

**得分规则**：
1. **生存分**：每存活一轮得 1 分（存活到本轮结束即获得）
2. **胜利分**：卧底胜利时（平民剩余≤1组），卧底额外获得 3 分

**分数累加**：
- 每局游戏结束后，本轮得分会累加到各组的总分上
- 总分会一直保留，直到游戏重置

**获取分数**：
- 通过 `/api/status` 接口的 `scores` 字段可查看所有组的累计总分
- 通过 `/api/result` 接口可查看本轮得分（`round_scores`）和累计总分（`total_scores`），详见 5.4 节
- 通过 `/api/scores` 接口可获取按分数排序的所有组总分列表
- 通过 WebSocket `scores_update` 事件可实时接收分数更新（详见 5.5 节）

## 6. 时间与频率限制
- 注册需在主持人公布的截止时间前完成，逾期无法参与当局。
- 状态轮询：建议 2~3 秒一次；请勿并发刷接口。
- 描述提交：每个发言者限时 30 秒，描述阶段总时长 180 秒，每个人都必须发言。
- 投票提交：投票阶段限时 120 秒，每个人都必须投票。
- **在线状态检测**：
  - 优先使用 WebSocket：如果客户端建立了 WebSocket 连接并成功注册，系统将基于 WebSocket 连接状态判断是否在线。
  - HTTP 降级方案：如果客户端未建立 WebSocket 连接，系统将使用 HTTP 请求活跃时间判断（调用 `/api/status` 时传递 `group_name` 参数会更新活跃时间，120秒未活跃视为离线）。

## 7. 异常处理与离线管理
- **断开连接处理**：
  - 如果客户端 WebSocket 连接断开，系统会自动检测并标记该玩家为离线。
  - 断开连接的玩家会被视为退出游戏，自动标记为淘汰。
  - 如果断开的是卧底，则平民立即胜利；如果断开的是平民，则根据剩余人数判定游戏是否继续。
- **离线玩家排除**：
  - 在游戏开始时，系统只给在线玩家分配角色和词语。
  - 离线玩家不会获得角色，也不会参与游戏，但仍会在组列表中显示（标记为离线/淘汰状态）。
- **建议**：游戏方客户端应建立 WebSocket 连接以获得准确的在线状态检测，并定期轮询 `/api/status` 接口及时获取游戏状态更新。

